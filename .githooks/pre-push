#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_PAGE_ASSET_CHECK:-0}" == "1" ]]; then
  echo "Skipping page asset pre-push checks (SKIP_PAGE_ASSET_CHECK=1)."
  exit 0
fi

if ! command -v node >/dev/null 2>&1; then
  echo "node is required for page asset pre-push checks. Install Node.js."
  exit 1
fi

remote_name="${1:-origin}"

while IFS=' ' read -r local_ref local_sha remote_ref remote_sha; do
  [[ -z "${local_sha:-}" ]] && continue

  # Skip deleted refs.
  if [[ "$local_sha" =~ ^0+$ ]]; then
    continue
  fi

  range=""
  if [[ "${remote_sha:-}" =~ ^0+$ ]]; then
    base=""
    if git rev-parse --verify "${remote_name}/main" >/dev/null 2>&1; then
      base="$(git merge-base "$local_sha" "${remote_name}/main")"
    elif git rev-parse --verify "origin/main" >/dev/null 2>&1; then
      base="$(git merge-base "$local_sha" "origin/main")"
    elif git rev-parse --verify "main" >/dev/null 2>&1; then
      base="$(git merge-base "$local_sha" "main")"
    fi

    if [[ -n "$base" ]]; then
      range="${base}..${local_sha}"
    else
      range="${local_sha}^..${local_sha}"
    fi
  else
    range="${remote_sha}..${local_sha}"
  fi

  html_files_output="$(git diff --name-only --diff-filter=ACMR "$range" -- '*.html' | sort -u)"
  if [[ -z "$html_files_output" ]]; then
    continue
  fi

  files=()
  while IFS= read -r file; do
    [[ -z "$file" ]] && continue
    files+=("$file")
  done <<< "$html_files_output"

  if [[ "${#files[@]}" -eq 0 ]]; then
    continue
  fi

  node scripts/check-referenced-page-assets.mjs --ref "$local_sha" "${files[@]}"
done

